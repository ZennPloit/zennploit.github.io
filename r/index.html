<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON TRACK â€¢ Processing</title>
    <style>
        :root {
            --neon-pink: #ff2a6d;
            --neon-blue: #05d9e8;
            --neon-green: #00ff9d;
            --dark-bg: #0d0221;
        }

        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }

        .container {
            max-width: 600px;
            padding: 20px;
        }

        h1 {
            color: var(--neon-green);
            margin-bottom: 30px;
        }

        .status {
            margin: 20px 0;
            font-size: 1.2rem;
        }

        .progress {
            height: 10px;
            background: rgba(5, 217, 232, 0.2);
            border-radius: 5px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(to right, var(--neon-pink), var(--neon-blue));
            animation: progress 3s forwards;
        }

        @keyframes progress {
            to { width: 100%; }
        }

        .permission-box {
            background: rgba(5, 217, 232, 0.1);
            border: 1px solid var(--neon-blue);
            padding: 20px;
            border-radius: 5px;
            margin: 30px 0;
            display: none;
        }

        button {
            background: var(--neon-pink);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NEON_TRACK</h1>
        <div class="status" id="statusText">Initializing tracking sequence...</div>
        
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
        
        <div class="permission-box" id="permissionBox">
            <p>Enable location access for enhanced analytics</p>
            <button id="allowBtn">ALLOW</button>
            <button id="skipBtn" class="btn-outline">SKIP</button>
        </div>
    </div>

    <script>
        // Get link ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');
        const statusText = document.getElementById('statusText');
        const permissionBox = document.getElementById('permissionBox');
        
        if (!linkId) {
            window.location.href = '/tracker/';
        }

        // Create click data object
        const clickData = {
            id: generateId(),
            linkId: linkId,
            timestamp: new Date().toISOString(),
            referrer: document.referrer || 'direct',
            userAgent: navigator.userAgent,
            screenWidth: window.screen.width,
            screenHeight: window.screen.height,
            ip: '',
            city: '',
            country: '',
            device: '',
            os: '',
            browser: '',
            latitude: null,
            longitude: null
        };

        // Simulation sequence
        setTimeout(() => {
            statusText.textContent = "Verifying link integrity...";
        }, 1000);

        setTimeout(() => {
            statusText.textContent = "Analyzing network...";
        }, 2000);

        setTimeout(() => {
            statusText.textContent = "Collecting device data...";
            getIPLocation();
        }, 3000);

        setTimeout(() => {
            statusText.textContent = "Optimizing delivery...";
            permissionBox.style.display = 'block';
        }, 4000);

        // Button handlers
        document.getElementById('allowBtn').addEventListener('click', () => {
            requestLocation();
        });

        document.getElementById('skipBtn').addEventListener('click', () => {
            completeRedirect();
        });

        // Get IP and approximate location
        function getIPLocation() {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    clickData.ip = data.ip;
                    clickData.city = data.city;
                    clickData.country = data.country_name;
                    detectDevice();
                })
                .catch(() => {
                    detectDevice();
                });
        }

        // Detect device info
        function detectDevice() {
            const ua = navigator.userAgent;
            
            // Detect OS
            if (ua.match(/Android/i)) {
                clickData.os = 'Android';
            } else if (ua.match(/iPhone|iPad|iPod/i)) {
                clickData.os = 'iOS';
            } else if (ua.match(/Windows/i)) {
                clickData.os = 'Windows';
            } else if (ua.match(/Macintosh/i)) {
                clickData.os = 'Mac OS';
            } else if (ua.match(/Linux/i)) {
                clickData.os = 'Linux';
            }
            
            // Detect browser
            if (ua.match(/Chrome/i)) {
                clickData.browser = 'Chrome';
            } else if (ua.match(/Firefox/i)) {
                clickData.browser = 'Firefox';
            } else if (ua.match(/Safari/i)) {
                clickData.browser = 'Safari';
            }
            
            // Simple device detection
            if (ua.match(/Mobile/i)) {
                clickData.device = 'Mobile';
            } else {
                clickData.device = 'Desktop';
            }
        }

        // Request location access
        function requestLocation() {
            statusText.textContent = "Requesting location...";
            permissionBox.style.display = 'none';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clickData.latitude = position.coords.latitude;
                        clickData.longitude = position.coords.longitude;
                        statusText.textContent = "Location acquired!";
                        setTimeout(completeRedirect, 1000);
                    },
                    () => {
                        statusText.textContent = "Location denied";
                        setTimeout(completeRedirect, 1000);
                    }
                );
            } else {
                completeRedirect();
            }
        }

        // Complete the process
        function completeRedirect() {
            // Find the destination URL
            const links = JSON.parse(localStorage.getItem('neonLinks') || []);
            const targetLink = links.find(link => link.id === linkId);
            
            if (!targetLink) {
                window.location.href = '/tracker/';
                return;
            }
            
            // Update click count
            targetLink.clicks = (targetLink.clicks || 0) + 1;
            localStorage.setItem('neonLinks', JSON.stringify(links));
            
            // Save click data
            const clicks = JSON.parse(localStorage.getItem('neonClicks') || []);
            clicks.push(clickData);
            localStorage.setItem('neonClicks', JSON.stringify(clicks));
            
            // Redirect to destination
            window.location.href = targetLink.destination;
        }

        // Generate random ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>
